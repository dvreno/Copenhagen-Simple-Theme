{{!-- templates/home_page.hbs --}}
<div class="dashboard-container">
  {{!-- System Alerts --}}
  {{#if help_center.system.active_announcements}}
    <div class="system-alerts">
      {{#each help_center.system.active_announcements}}
        <div class="alert alert-{{type}}">
          {{message}}
        </div>
      {{/each}}
    </div>
  {{/if}}

  {{!-- Hero Section --}}
  <section class="hero-section">
    <div class="container">
      <div class="hero-content">
        {{#if signed_in}}
          <h1 class="hero-title">Welcome back, {{user.name}}!</h1>
          <p class="hero-subtitle">How can we help you today?</p>
        {{else}}
          <h1 class="hero-title">Welcome to {{help_center.name}}</h1>
          <p class="hero-subtitle">Find answers, submit requests, and explore our resources</p>
        {{/if}}
        
        {{!-- Search Bar --}}
        <div class="hero-search">
          {{search submit=false class='hero-search-form' scoped=settings.scoped_kb_search}}
        </div>
      </div>
    </div>
  </section>

  {{!-- Quick Actions --}}
  <section class="quick-actions">
    <div class="container">
      <div class="action-grid">
        {{#if signed_in}}
          <a href="{{page_path 'new_request'}}" class="action-card">
            <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            <h3>Submit Request</h3>
            <p>Get help from our support team</p>
          </a>
          
          <a href="{{page_path 'requests'}}" class="action-card">
            <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <h3>My Requests</h3>
            <p>View and track your tickets</p>
          </a>
        {{/if}}
        
        <a href="{{help_center.url}}" class="action-card">
          <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11H3V2h6v9zm0 0l3 3 3-3m6 0h-6v9h6v-9zm0 0l-3-3-3 3"></path>
          </svg>
          <h3>Browse Articles</h3>
          <p>Explore our knowledge base</p>
        </a>
        
        {{#if help_center.community_enabled}}
          <a href="{{page_path 'community'}}" class="action-card">
            <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <h3>Community</h3>
            <p>Connect with other users</p>
          </a>
        {{/if}}
      </div>
    </div>
  </section>

  {{!-- User Dashboard (Signed-in only) --}}
  {{#if signed_in}}
    <section class="user-dashboard">
      <div class="container">
        <h2 class="section-title">Your Activity</h2>
        
        <div class="dashboard-grid">
          {{!-- Recent Tickets Widget --}}
          <div class="dashboard-widget">
            <div class="widget-header">
              <h3>Recent Requests</h3>
              <a href="{{page_path 'requests'}}" class="widget-link">View all →</a>
            </div>
            <div class="widget-content" id="recent-requests">
              <div class="loading">Loading...</div>
            </div>
          </div>
          
          {{!-- Following Widget --}}
          <div class="dashboard-widget">
            <div class="widget-header">
              <h3>Following</h3>
              <a href="{{page_path 'following'}}" class="widget-link">Manage →</a>
            </div>
            <div class="widget-content" id="following-content">
              <div class="loading">Loading...</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  {{/if}}

  {{!-- Featured Articles --}}
  {{#if promoted_articles}}
    <section class="featured-articles">
      <div class="container">
        <h2 class="section-title">Featured Articles</h2>
        <div class="articles-grid">
          {{#each promoted_articles}}
            <article class="article-card">
              <h3><a href="{{url}}">{{title}}</a></h3>
              <p class="article-meta">
                {{#if section}}
                  in {{section.name}}
                {{/if}}
              </p>
            </article>
          {{/each}}
        </div>
      </div>
    </section>
  {{/if}}

  {{!-- Knowledge Base Categories --}}
  <section class="knowledge-base">
    <div class="container">
      <h2 class="section-title">Browse Help Center</h2>
      <div class="categories-grid">
        {{#each categories}}
          <div class="category-card">
            <h3 class="category-title">
              <a href="{{url}}">{{name}}</a>
            </h3>
            {{#if description}}
              <p class="category-description">{{description}}</p>
            {{/if}}
            <div class="category-meta">
              {{#if sections}}
                <span class="section-count">{{sections.length}} sections</span>
              {{/if}}
            </div>
            
            {{!-- Show top sections --}}
            {{#if sections}}
              <ul class="section-list">
                {{#each sections}}
                  {{#if @index}}
                    {{#unless (gt @index 2)}}
                      <li><a href="{{url}}">{{name}}</a></li>
                    {{/unless}}
                  {{else}}
                    <li><a href="{{url}}">{{name}}</a></li>
                  {{/if}}
                {{/each}}
              </ul>
            {{/if}}
          </div>
        {{/each}}
      </div>
    </div>
  </section>

  {{!-- Recent Activity --}}
  <section class="recent-activity">
    <div class="container">
      <div class="activity-header">
        <h2 class="section-title">Recent Updates</h2>
        <div class="activity-filters">
          <a href="{{help_center.url}}/articles?sort_by=created_at" class="filter-link">Newest</a>
          <a href="{{help_center.url}}/articles?sort_by=updated_at" class="filter-link">Recently Updated</a>
        </div>
      </div>
      
      <div class="activity-content" id="recent-articles">
        <div class="loading">Loading recent articles...</div>
      </div>
    </div>
  </section>

  {{!-- Community Section --}}
  {{#if help_center.community_enabled}}
    <section class="community-section">
      <div class="container">
        <div class="community-header">
          <h2 class="section-title">Community Activity</h2>
          <a href="{{page_path 'community'}}" class="section-link">Visit Community →</a>
        </div>
        
        <div class="community-grid">
          <div class="community-stats">
            <div class="stat-card">
              <span class="stat-number" id="community-posts">-</span>
              <span class="stat-label">Posts</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="community-members">-</span>
              <span class="stat-label">Members</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="community-solutions">-</span>
              <span class="stat-label">Solutions</span>
            </div>
          </div>
          
          <div class="community-latest" id="latest-posts">
            <h3>Latest Discussions</h3>
            <div class="loading">Loading posts...</div>
          </div>
        </div>
      </div>
    </section>
  {{/if}}

  {{!-- Footer Actions --}}
  <section class="footer-actions">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-card">
          <h3>Can't find what you're looking for?</h3>
          <p>Our support team is here to help</p>
          {{#if signed_in}}
            <a href="{{page_path 'new_request'}}" class="btn btn-primary">Contact Support</a>
          {{else}}
            <a href="{{page_path 'signin'}}" class="btn btn-primary">Sign In</a>
          {{/if}}
        </div>
        
        <div class="footer-card">
          <h3>Stay Updated</h3>
          <p>Get the latest updates and announcements</p>
          <a href="{{page_path 'following'}}" class="btn btn-secondary">Manage Subscriptions</a>
        </div>
        
        {{#if help_center.community_enabled}}
          <div class="footer-card">
            <h3>Join the Discussion</h3>
            <p>Connect with our community</p>
            <a href="{{page_path 'community'}}" class="btn btn-secondary">Visit Community</a>
          </div>
        {{/if}}
      </div>
    </div>
  </section>
</div>

{{!-- Custom JavaScript for dynamic content --}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load recent requests for signed-in users
  if (window.HelpCenter && window.HelpCenter.user && window.HelpCenter.user.role !== 'anonymous') {
    loadRecentRequests();
    loadFollowingContent();
  }
  
  // Load recent articles
  loadRecentArticles();
  
  // Load community stats if enabled
  if (document.getElementById('community-posts')) {
    loadCommunityStats();
    loadLatestPosts();
  }
});

function loadRecentRequests() {
  fetch('/api/v2/requests.json?per_page=5&sort_by=updated_at&sort_order=desc')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('recent-requests');
      if (data.requests && data.requests.length > 0) {
        let html = '<ul class="request-list">';
        data.requests.forEach(request => {
          const statusClass = request.status.replace(/_/g, '-');
          html += `
            <li class="request-item">
              <a href="/hc/requests/${request.id}">
                <span class="request-subject">${escapeHtml(request.subject)}</span>
                <span class="request-status status-${statusClass}">${request.status}</span>
              </a>
            </li>
          `;
        });
        html += '</ul>';
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="no-content">No recent requests</p>';
      }
    })
    .catch(error => {
      console.error('Error loading requests:', error);
      document.getElementById('recent-requests').innerHTML = '<p class="error">Unable to load requests</p>';
    });
}

function loadFollowingContent() {
  fetch('/api/v2/help_center/users/me/subscriptions.json?per_page=5')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('following-content');
      if (data.subscriptions && data.subscriptions.length > 0) {
        let html = '<ul class="following-list">';
        data.subscriptions.forEach(sub => {
          html += `
            <li class="following-item">
              <a href="${sub.content_url}">${escapeHtml(sub.title)}</a>
              <span class="content-type">${sub.content_type}</span>
            </li>
          `;
        });
        html += '</ul>';
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="no-content">Not following any content yet</p>';
      }
    })
    .catch(error => {
      console.error('Error loading following:', error);
      document.getElementById('following-content').innerHTML = '<p class="error">Unable to load content</p>';
    });
}

function loadRecentArticles() {
  fetch('/api/v2/help_center/articles.json?sort_by=updated_at&sort_order=desc&per_page=6')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('recent-articles');
      if (data.articles && data.articles.length > 0) {
        let html = '<div class="articles-list">';
        data.articles.forEach(article => {
          const date = new Date(article.updated_at).toLocaleDateString();
          html += `
            <article class="article-item">
              <h4><a href="${article.html_url}">${escapeHtml(article.title)}</a></h4>
              <p class="article-meta">Updated ${date}</p>
            </article>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="no-content">No recent articles</p>';
      }
    })
    .catch(error => {
      console.error('Error loading articles:', error);
      document.getElementById('recent-articles').innerHTML = '<p class="error">Unable to load articles</p>';
    });
}

function loadCommunityStats() {
  // Note: These endpoints may vary based on your Zendesk configuration
  fetch('/api/v2/community/posts.json?per_page=1')
    .then(response => response.json())
    .then(data => {
      if (data.count !== undefined) {
        document.getElementById('community-posts').textContent = data.count;
      }
    })
    .catch(console.error);
}

function loadLatestPosts() {
  fetch('/api/v2/community/posts.json?per_page=5&sort_by=created_at&sort_order=desc')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('latest-posts');
      if (data.posts && data.posts.length > 0) {
        let html = '<h3>Latest Discussions</h3><ul class="post-list">';
        data.posts.forEach(post => {
          html += `
            <li class="post-item">
              <a href="${post.html_url}">${escapeHtml(post.title)}</a>
              <span class="post-meta">${post.comment_count} replies</span>
            </li>
          `;
        });
        html += '</ul>';
        container.innerHTML = html;
      } else {
        container.innerHTML = '<h3>Latest Discussions</h3><p class="no-content">No recent posts</p>';
      }
    })
    .catch(error => {
      console.error('Error loading posts:', error);
      document.getElementById('latest-posts').innerHTML = '<h3>Latest Discussions</h3><p class="error">Unable to load posts</p>';
    });
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
</script>